name: CI/CD

on:
  push:
    branches: [ ops/dockerization ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [14.x]

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      # - name: Copy env
      #   uses: canastro/copy-file-action@master
      #   with:
      #     source: "env/staging.env"
      #     target: ".env"
      #
      # - name: Install libraries
      #   run: npm i
      #
      # - name: Build application
      #   run: npm run build
      #
      # - name: Build image and push to docker registry
      #   uses: docker/build-push-action@v1
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      #     repository: ${{ secrets.DOCKER_IMAGE }}
      #     registry: cr.yandex
      #     tags: latest
      #
      # - name: Build image and push to docker registry
      #   uses: docker/build-push-action@v1
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      #     repository: ${{ secrets.DOCKER_IMAGE }}
      #     registry: cr.yandex
      #     tags: latest

      - name: Deploy app
        run: |
          echo "$PRIVATE_KEY" >> ./deploy/private-key.txt
          chmod 600 ./deploy/private-key.txt
          docker build . --file Dockerfile.deploy --build-arg "$env1 $env2 $env3 $env4 $env5 $env6 $env7"
        env:
          env1: "ENV=staging"
          env2: "HOST_IP=${{ secrets.STAGING_IP }}"
          env3: "DOCKER_IMAGE=${{ secrets.DOCKER_IMAGE }}"
          env4: "BUILD_VERSION=latest"
          env5: "DOCKER_REGISTRY=cr.yandex"
          env6: "DOCKER_REGISTRY_USER=${{ secrets.DOCKER_USERNAME }}"
          env7: "DOCKER_REGISTRY_PASS=${{ secrets.DOCKER_PASSWORD }}"
          HOST_IP: "${{ secrets.STAGING_IP }}"
          PRIVATE_KEY: "${{ secrets.STAGING_PRIVATE_KEY }}"